# 🚀 Claude Relay Service Configuration

# 🌐 服务器配置
PORT=3000
HOST=0.0.0.0
NODE_ENV=production

# 🔐 安全配置
JWT_SECRET=your-jwt-secret-here
ADMIN_SESSION_TIMEOUT=86400000
API_KEY_PREFIX=cr_
ENCRYPTION_KEY=your-encryption-key-here

# 👤 管理员凭据（可选，不设置则自动生成）
# ADMIN_USERNAME=cr_admin_custom
# ADMIN_PASSWORD=your-secure-password

# 📊 Redis 配置
# 生产环境优先使用 CRS_REDIS_URL（支持 redis:// 或 rediss:// 格式）
# 示例: redis://user:password@host:port/db 或 rediss://user:password@host:port/db
# CRS_REDIS_URL=redis://:password@localhost:6379/0
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_ENABLE_TLS=

# 🔗 会话管理配置
# 粘性会话TTL配置（小时），默认1小时
STICKY_SESSION_TTL_HOURS=1
# 续期阈值（分钟），默认0分钟（不续期）
STICKY_SESSION_RENEWAL_THRESHOLD_MINUTES=15

# 🎯 Claude API 配置
CLAUDE_API_URL=https://api.anthropic.com/v1/messages
CLAUDE_API_VERSION=2023-06-01
CLAUDE_BETA_HEADER=claude-code-20250219,oauth-2025-04-20,interleaved-thinking-2025-05-14,fine-grained-tool-streaming-2025-05-14

# 🚫 529错误处理配置
# 启用529错误处理，0表示禁用，>0表示过载状态持续时间（分钟）
CLAUDE_OVERLOAD_HANDLING_MINUTES=0

# 400错误处理：0表示禁用，>0表示临时禁用时间（分钟）
# 只有匹配特定错误模式的 400 才会触发临时禁用
#  - organization has been disabled
#  - account has been disabled
#  - account is disabled
#  - no account supporting
#  - account not found
#  - invalid account
#  - Too many active sessions
CLAUDE_CONSOLE_BLOCKED_HANDLING_MINUTES=10

# 🌐 代理配置
DEFAULT_PROXY_TIMEOUT=600000
MAX_PROXY_RETRIES=3
# IP协议族配置：true=IPv4, false=IPv6, 默认IPv4（兼容性更好）
PROXY_USE_IPV4=true
# 代理连接池 / Keep-Alive 配置（默认关闭，如需启用请取消注释）
# PROXY_KEEP_ALIVE=true
# PROXY_MAX_SOCKETS=50
# PROXY_MAX_FREE_SOCKETS=10

# ⏱️ 请求超时配置
REQUEST_TIMEOUT=600000  # 请求超时设置（毫秒），默认10分钟

# 📈 使用限制
DEFAULT_TOKEN_LIMIT=1000000

# 📝 日志配置
LOG_LEVEL=info
LOG_MAX_SIZE=10m
LOG_MAX_FILES=5

# 🔧 系统配置
CLEANUP_INTERVAL=3600000
TOKEN_USAGE_RETENTION=2592000000
HEALTH_CHECK_INTERVAL=60000
TIMEZONE_OFFSET=8  # UTC偏移小时数，默认+8（中国时区）
METRICS_WINDOW=5  # 实时指标统计窗口（分钟），可选1-60，默认5分钟

# 🎲 调度策略配置
# 调度策略：binary（原有二元策略）| probabilistic（概率权重策略）
SCHEDULING_STRATEGY=binary
# 健康分恢复周期（小时），每周期恢复5分
SCHEDULING_HEALTH_DECAY_HOURS=1
# 最低健康分（保底探测机会），默认5
SCHEDULING_MIN_HEALTH_SCORE=5
# 权重指数，越大越倾向高分账户，默认2
# SCHEDULING_WEIGHT_EXPONENT=2

# 🔄 故障转移配置
# 是否启用自动故障转移（账户请求失败时自动切换）
FAILOVER_ENABLED=false
# 最大重试次数（不含首次请求）
FAILOVER_MAX_RETRIES=2

# 🎨 Web 界面配置
WEB_TITLE=Claude Relay Service
WEB_DESCRIPTION=Multi-account Claude API relay service with beautiful management interface
WEB_LOGO_URL=/assets/logo.png

# 🛠️ 开发配置
DEBUG=false
DEBUG_HTTP_TRAFFIC=false  # 启用HTTP请求/响应调试日志（仅开发环境）
ENABLE_CORS=true
TRUST_PROXY=true

# 🔒 客户端限制（可选）
# ALLOW_CUSTOM_CLIENTS=false

# 🔐 LDAP 认证配置
LDAP_ENABLED=false
LDAP_URL=ldaps://ldap-1.test1.bj.yxops.net:636
LDAP_BIND_DN=cn=admin,dc=example,dc=com
LDAP_BIND_PASSWORD=admin_password
LDAP_SEARCH_BASE=dc=example,dc=com
LDAP_SEARCH_FILTER=(uid={{username}})
LDAP_SEARCH_ATTRIBUTES=dn,uid,cn,mail,givenName,sn
LDAP_TIMEOUT=5000
LDAP_CONNECT_TIMEOUT=10000

# 🔒 LDAP TLS/SSL 配置 (用于 ldaps:// URL)
# 是否忽略证书验证错误 (设置为false可忽略自签名证书错误)
LDAP_TLS_REJECT_UNAUTHORIZED=true
# CA 证书文件路径 (可选，用于自定义CA证书)
# LDAP_TLS_CA_FILE=/path/to/ca-cert.pem
# 客户端证书文件路径 (可选，用于双向认证)
# LDAP_TLS_CERT_FILE=/path/to/client-cert.pem
# 客户端私钥文件路径 (可选，用于双向认证)
# LDAP_TLS_KEY_FILE=/path/to/client-key.pem
# 服务器名称 (可选，用于 SNI)
# LDAP_TLS_SERVERNAME=ldap.example.com

# 🗺️ LDAP 用户属性映射
LDAP_USER_ATTR_USERNAME=uid
LDAP_USER_ATTR_DISPLAY_NAME=cn
LDAP_USER_ATTR_EMAIL=mail
LDAP_USER_ATTR_FIRST_NAME=givenName
LDAP_USER_ATTR_LAST_NAME=sn

# 👥 用户管理配置
USER_MANAGEMENT_ENABLED=false
DEFAULT_USER_ROLE=user
USER_SESSION_TIMEOUT=86400000
MAX_API_KEYS_PER_USER=1
ALLOW_USER_DELETE_API_KEYS=false

# 📢 Webhook 通知配置
WEBHOOK_ENABLED=true
# Webhook URL列表（逗号分隔）
# WEBHOOK_URLS=https://hooks.slack.com/xxx,https://discord.com/api/webhooks/xxx
WEBHOOK_URLS=
# Webhook 请求超时（毫秒）
WEBHOOK_TIMEOUT=10000
# Webhook 重试次数
WEBHOOK_RETRIES=3
# 🔒 允许本地 Webhook 地址（开发/测试环境使用）
# 设置为 true 时允许向 localhost、127.0.0.1、192.168.x.x 等本地/私有IP发送请求
# 注意：开发环境（NODE_ENV=development）会自动允许，无需设置此项
# 生产环境请勿开启此选项以防止 SSRF 攻击！
WEBHOOK_ALLOW_LOCAL_URLS=false
# 🔒 Webhook 域名白名单（可选，逗号分隔）
# 如果设置了白名单，只有白名单中的域名才能接收通知（防止SSRF攻击）
# 留空表示允许所有合法的公网域名（但仍会阻止私有IP和本地地址）
# WEBHOOK_ALLOWED_DOMAINS=hooks.slack.com,discord.com,api.telegram.org,qyapi.weixin.qq.com,oapi.dingtalk.com,open.feishu.cn
WEBHOOK_ALLOWED_DOMAINS=

# Claude CLI 请求伪装（将多用户伪装成单一上游身份）
DISGUISE_ENABLED=false                 # 是否启用伪装（默认禁用）
DISGUISE_AUTO_VERSION=true             # 自动使用最新版本（默认启用）

# 优先级队列配置
DISGUISE_SESSION_QUEUE_SIZE=15         # SessionId 队列大小（默认15）

# 在线集合配置
DISGUISE_MAX_ONLINE_SESSIONS=3         # 最大在线 SessionId 数量（默认3）
DISGUISE_MIN_ONLINE_SESSIONS=2         # 最小在线 SessionId 数量（默认2）

# 双层概率轮换配置
DISGUISE_ROTATION_P1=0.15              # 第一层概率：是否考虑轮换（0.15 = 15%）
DISGUISE_ROTATION_P2=0.4               # 第二层概率：轮换几个（0.4 = 40%）
DISGUISE_MAX_ROTATION_COUNT=1          # 每次最多轮换数量（默认1）

# 保护配置
DISGUISE_MIN_ROTATION_INTERVAL=30      # 最小轮换间隔（秒，默认30秒）

# SessionId 收集配置
DISGUISE_COLLECTION_MIN_INTERVAL=60    # 同一 API Key 最小收集间隔（秒，默认60秒）

# Codex 请求伪装（将多用户伪装成单一上游身份，仅修改 session_id）
CODEX_DISGUISE_ENABLED=false           # 是否启用 Codex 伪装（默认禁用）

# 优先级队列配置
CODEX_SESSION_QUEUE_SIZE=15            # SessionId 队列大小（默认15）

# 在线集合配置
CODEX_MAX_ONLINE_SESSIONS=3            # 最大在线 SessionId ��量（默认3）
CODEX_MIN_ONLINE_SESSIONS=2            # 最小在线 SessionId 数量（默认2）

# 双层概率轮换配置
CODEX_ROTATION_P1=0.15                 # 第一层概率：是否考虑轮换（0.15 = 15%）
CODEX_ROTATION_P2=0.4                  # 第二层概率：轮换几个（0.4 = 40%）
CODEX_MAX_ROTATION_COUNT=1             # 每次最多轮换数量（默认1）

# 保护配置
CODEX_MIN_ROTATION_INTERVAL=30         # 最小轮换间隔（秒，默认30秒）

# SessionId 收集配置
CODEX_COLLECTION_MIN_INTERVAL=60       # 同一 API Key 最小收集间隔（秒，默认60秒）

# 调试配置
DEBUG_DISGUISE=false                   # 是否启用伪装调试日志（默认禁用）

# 🔍 调试和测试配置
# 请求捕获中间件（用于调试和测试，默认禁用）
# 启用后会捕获前50个Claude Code请求的详细信息到 logs/captured-requests/
CAPTURE_REQUESTS_ENABLED=false

# Codex 请求日志配置
# 启用后会记录所有 Codex/OpenAI Responses 请求的详细信息到 logs/codex-requests/ 和 Redis
# 适用于调试和分析 Codex 请求格式
CODEX_REQUEST_LOGGING=false
