# 🚀 Claude Relay Service Configuration

# 🌐 服务器配置
PORT=3000
HOST=0.0.0.0
NODE_ENV=production

# 🔐 安全配置
JWT_SECRET=your-jwt-secret-here
ADMIN_SESSION_TIMEOUT=86400000
API_KEY_PREFIX=cr_
ENCRYPTION_KEY=your-encryption-key-here

# 👤 管理员凭据（可选，不设置则自动生成）
# ADMIN_USERNAME=cr_admin_custom
# ADMIN_PASSWORD=your-secure-password

# 📊 Redis 配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_ENABLE_TLS=

# 🔗 会话管理配置
# 粘性会话TTL配置（小时），默认1小时
STICKY_SESSION_TTL_HOURS=1
# 续期阈值（分钟），默认0分钟（不续期）
STICKY_SESSION_RENEWAL_THRESHOLD_MINUTES=15

# 🎯 Claude API 配置
CLAUDE_API_URL=https://api.anthropic.com/v1/messages
CLAUDE_API_VERSION=2023-06-01
CLAUDE_BETA_HEADER=claude-code-20250219,oauth-2025-04-20,interleaved-thinking-2025-05-14,fine-grained-tool-streaming-2025-05-14

# 🚫 529错误处理配置
# 启用529错误处理，0表示禁用，>0表示过载状态持续时间（分钟）
CLAUDE_OVERLOAD_HANDLING_MINUTES=0

# 400错误处理：0表示禁用，>0表示临时禁用时间（分钟）
# 只有匹配特定错误模式的 400 才会触发临时禁用
#  - organization has been disabled
#  - account has been disabled
#  - account is disabled
#  - no account supporting
#  - account not found
#  - invalid account
#  - Too many active sessions
CLAUDE_CONSOLE_BLOCKED_HANDLING_MINUTES=10

# 🌐 代理配置
DEFAULT_PROXY_TIMEOUT=600000
MAX_PROXY_RETRIES=3
# IP协议族配置：true=IPv4, false=IPv6, 默认IPv4（兼容性更好）
PROXY_USE_IPV4=true
# 代理连接池 / Keep-Alive 配置（默认关闭，如需启用请取消注释）
# PROXY_KEEP_ALIVE=true
# PROXY_MAX_SOCKETS=50
# PROXY_MAX_FREE_SOCKETS=10

# ⏱️ 请求超时配置
REQUEST_TIMEOUT=600000  # 请求超时设置（毫秒），默认10分钟

# 🔧 请求体大小配置
REQUEST_MAX_SIZE_MB=60

# 📈 使用限制
DEFAULT_TOKEN_LIMIT=1000000

# 📝 日志配置
LOG_LEVEL=info
LOG_MAX_SIZE=10m
LOG_MAX_FILES=5

# 🔧 系统配置
CLEANUP_INTERVAL=3600000
TOKEN_USAGE_RETENTION=2592000000
HEALTH_CHECK_INTERVAL=60000
TIMEZONE_OFFSET=8  # UTC偏移小时数，默认+8（中国时区）
METRICS_WINDOW=5  # 实时指标统计窗口（分钟），可选1-60，默认5分钟
# 启动时清理残留的并发排队计数器（默认true，多实例部署时建议设为false）
CLEAR_CONCURRENCY_QUEUES_ON_STARTUP=true

# 🎨 Web 界面配置
WEB_TITLE=Claude Relay Service
WEB_DESCRIPTION=Multi-account Claude API relay service with beautiful management interface
WEB_LOGO_URL=/assets/logo.png

# 🛠️ 开发配置
DEBUG=false
DEBUG_HTTP_TRAFFIC=false  # 启用HTTP请求/响应调试日志（仅开发环境）
ENABLE_CORS=true
TRUST_PROXY=true

# 🔒 客户端限制（可选）
# ALLOW_CUSTOM_CLIENTS=false

# 🔐 LDAP 认证配置
LDAP_ENABLED=false
LDAP_URL=ldaps://ldap-1.test1.bj.yxops.net:636
LDAP_BIND_DN=cn=admin,dc=example,dc=com
LDAP_BIND_PASSWORD=admin_password
LDAP_SEARCH_BASE=dc=example,dc=com
LDAP_SEARCH_FILTER=(uid={{username}})
LDAP_SEARCH_ATTRIBUTES=dn,uid,cn,mail,givenName,sn
LDAP_TIMEOUT=5000
LDAP_CONNECT_TIMEOUT=10000

# 🔒 LDAP TLS/SSL 配置 (用于 ldaps:// URL)
# 是否忽略证书验证错误 (设置为false可忽略自签名证书错误)
LDAP_TLS_REJECT_UNAUTHORIZED=true
# CA 证书文件路径 (可选，用于自定义CA证书)
# LDAP_TLS_CA_FILE=/path/to/ca-cert.pem
# 客户端证书文件路径 (可选，用于双向认证)
# LDAP_TLS_CERT_FILE=/path/to/client-cert.pem
# 客户端私钥文件路径 (可选，用于双向认证)
# LDAP_TLS_KEY_FILE=/path/to/client-key.pem
# 服务器名称 (可选，用于 SNI)
# LDAP_TLS_SERVERNAME=ldap.example.com

# 🗺️ LDAP 用户属性映射
LDAP_USER_ATTR_USERNAME=uid
LDAP_USER_ATTR_DISPLAY_NAME=cn
LDAP_USER_ATTR_EMAIL=mail
LDAP_USER_ATTR_FIRST_NAME=givenName
LDAP_USER_ATTR_LAST_NAME=sn

# 👥 用户管理配置
USER_MANAGEMENT_ENABLED=false
DEFAULT_USER_ROLE=user
USER_SESSION_TIMEOUT=86400000
MAX_API_KEYS_PER_USER=1
ALLOW_USER_DELETE_API_KEYS=false

# 💰 费用倍率配置
# 全局倍率（默认1.0，所有模型费用乘以此值）
# COST_MULTIPLIER=1.0
# 模型特定倍率（与全局倍率相乘）
# 格式: COST_MULTIPLIER_<MODEL_KEY>=<倍率>
# MODEL_KEY: 模型名中的 - 替换为 _，全部大写
# 示例: Opus 额外 1.5 倍（全局 1.5 * 模型 1.5 = 2.25 倍）
# COST_MULTIPLIER_CLAUDE_OPUS_4_5=1.5

# 🎭 Session Pool 配置 (动态 session_id 管理)
# 启用 session pool (默认: true)
USE_SESSION_POOL=true
# 最小池大小 (默认: 3)
SESSION_POOL_MIN_SIZE=3
# 最大池大小 (默认: 20)
SESSION_POOL_MAX_SIZE=20
# 切换概率 (0.0-1.0, 默认: 0.1 即 10%)
SESSION_SWITCH_PROBABILITY=0.1
# 最小切换间隔 (毫秒, 默认: 300000 即 5 分钟)
SESSION_MIN_SWITCH_INTERVAL_MS=300000

# 🎭 伪装配置 (Fallback 值，当 session pool 禁用时使用)
# DISGUISE_SESSION_ID=9f10edbb-1407-47e1-9b85-fa634be33732
# DISGUISE_CLIENT_ID=1afa2e8165ce838aac57ba26c30a0b8468f0b287fcfce2d8b6e2f6169ebf76cf
# DISGUISE_UA=claude-cli/2.0.69 (external, cli)
# Sentry Public Key (用于 baggage 头，默认值来自真实 Claude CLI)
# SENTRY_PUBLIC_KEY=e531a1d9ec1de9064fae9d4affb0b0f4

# 🎭 Codex Session Pool 配置 (动态 session_id 管理)
# User-Agent 伪装
CODEX_USER_AGENT=codex_cli_rs/0.72.0
# 启用 codex session pool (默认: true)
USE_CODEX_SESSION_POOL=true
# 最小池大小 (默认: 3)
CODEX_SESSION_POOL_MIN_SIZE=3
# 最大池大小 (默认: 20)
CODEX_SESSION_POOL_MAX_SIZE=20
# 切换概率 (0.0-1.0, 默认: 0.1 即 10%)
CODEX_SESSION_SWITCH_PROBABILITY=0.1
# 最小切换间隔 (毫秒, 默认: 300000 即 5 分钟)
CODEX_SESSION_MIN_SWITCH_INTERVAL_MS=300000
