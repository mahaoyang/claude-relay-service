<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Key 统计查询 - JojoCode</title>
  <meta name="description" content="查询您的 API Key 使用统计、费用消耗和配额状态">
  <link rel="stylesheet" href="/public-pages/assets/lily-ui.css">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    [x-cloak] { display: none !important; }
    .stat-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid var(--sand-6); border-radius: 16px; transition: all 0.3s ease; }
    .stat-card:hover { box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); transform: translateY(-2px); }
    .dark .stat-card { background: rgba(30, 30, 35, 0.8); border: 1px solid var(--sand-7); }
    .stat-card-main { position: relative; overflow: hidden; padding: 20px; }
    .stat-card-main .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; }
    .stat-card-main .stat-icon svg { width: 24px; height: 24px; color: white; }
    .stat-card-main .stat-label { font-size: 13px; color: var(--sand-11); margin-bottom: 4px; }
    .stat-card-main .stat-value { font-size: 28px; font-weight: 700; color: var(--sand-12); line-height: 1.2; }
    .icon-blue { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
    .icon-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .icon-purple { background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); }
    .icon-amber { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .progress-container { background: var(--sand-4); border-radius: 999px; height: 8px; overflow: hidden; }
    .progress-bar-fill { height: 100%; border-radius: 999px; transition: width 0.5s ease; }
    .progress-blue { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
    .progress-green { background: linear-gradient(90deg, #10b981, #34d399); }
    .progress-red { background: linear-gradient(90deg, #ef4444, #f87171); }
    .input-glass { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); border: 1px solid var(--sand-7); transition: all 0.2s ease; }
    .input-glass:focus { outline: none; border-color: var(--accent-8); box-shadow: 0 0 0 3px var(--accent-3); }
    .dark .input-glass { background: rgba(0, 0, 0, 0.3); }
    .model-card { background: var(--sand-2); border-radius: 12px; padding: 16px; transition: all 0.2s ease; }
    .model-card:hover { background: var(--sand-3); }
    .dark .model-card { background: var(--sand-3); }
    .dark .model-card:hover { background: var(--sand-4); }
    .stats-grid { display: grid; gap: 16px; }
    .stats-grid-4 { grid-template-columns: repeat(4, 1fr); }
    .stats-grid-2 { grid-template-columns: repeat(2, 1fr); }
    @media (max-width: 1024px) { .stats-grid-4 { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 640px) { .stats-grid-4, .stats-grid-2 { grid-template-columns: 1fr; } }
    .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 500; }
    .badge-accent { background: var(--accent-3); color: var(--accent-11); }
    .badge-green { background: rgba(16, 185, 129, 0.15); color: #059669; }
    .dark .badge-green { color: #34d399; }
  </style>
</head>
<body data-scaling="100%" data-radius="medium" class="rt-Theme radix-themes min-h-screen text-sand-12 antialiased bg-gradient-to-br from-iris-2 to-violet-2" data-is-root-theme="true" x-data="statsApp()" x-init="init()" :class="[theme === 'dark' ? 'dark' : '', 'accent-' + accent]" :data-accent-color="accent">
  <nav class="fixed top-6 left-1/2 -translate-x-1/2 z-50 w-[95%] max-w-5xl rounded-4 backdrop-blur-xl shadow-lg" :class="theme === 'dark' ? 'bg-sand-1/60' : 'bg-sand-2/60'">
    <div class="px-4 sm:px-6 flex h-14 items-center justify-between">
      <a href="/" class="flex items-center gap-2 text-sm font-bold text-sand-12 hover:opacity-80">
        <svg class="w-5 h-5 text-accent-9" fill="currentColor" viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
        API Key 统计
      </a>
      <div class="flex items-center gap-3">
        <a href="/" class="text-xs text-sand-11 hover:text-accent-9">返回首页</a>
        <button @click="theme = theme === 'light' ? 'dark' : 'light'" class="flex h-7 w-7 items-center justify-center rounded-full hover:bg-sand-4/50">
          <svg x-show="theme === 'light'" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
          <svg x-show="theme === 'dark'" x-cloak class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        </button>
      </div>
    </div>
  </nav>
  <main class="pt-28 pb-16 px-4">
    <div class="max-w-5xl mx-auto">
      <div class="stat-card p-6 mb-6">
        <h2 class="text-lg font-bold text-sand-12 mb-4">输入您的 API Key</h2>
        <div class="flex gap-3">
          <input type="text" x-model="apiKeyId" @keyup.enter="queryStats()" placeholder="输入 API Key（如 cr_xxx）或 ID（UUID 格式）" class="input-glass flex-1 px-4 py-2.5 rounded-xl text-sm text-sand-12 placeholder-sand-9" />
          <button @click="queryStats()" :disabled="loading" class="px-6 py-2.5 rounded-xl bg-accent-9 text-white font-semibold text-sm hover:bg-accent-10 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
            <span x-show="!loading">查询</span>
            <span x-show="loading" x-cloak>查询中...</span>
          </button>
        </div>
        <div x-show="error" x-cloak class="mt-4 p-3 rounded-xl bg-red-3 border border-red-7 text-red-11 text-sm"><span x-text="error"></span></div>
      </div>
      <div x-show="statsData" x-cloak class="space-y-6">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold text-sand-12" x-text="statsData?.name || 'API Key 统计'"></h2>
          <span class="badge badge-green"><svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3"/></svg>活跃</span>
        </div>
        <div class="stats-grid stats-grid-4">
          <div class="stat-card stat-card-main">
            <div class="stat-icon icon-blue"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg></div>
            <div class="stat-label">总请求数</div>
            <div class="stat-value" x-text="statsData?.usage.total.requests.toLocaleString()"></div>
          </div>
          <div class="stat-card stat-card-main">
            <div class="stat-icon icon-green"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A2 2 0 013 12V7a4 4 0 014-4z"/></svg></div>
            <div class="stat-label">总 Token 消耗</div>
            <div class="stat-value" x-text="statsData?.usage.total.allTokens.toLocaleString()"></div>
          </div>
          <div class="stat-card stat-card-main">
            <div class="stat-icon icon-purple"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
            <div class="stat-label">总费用</div>
            <div class="stat-value" x-text="statsData?.usage.total.formattedCost"></div>
          </div>
          <div class="stat-card stat-card-main">
            <div class="stat-icon icon-amber"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></div>
            <div class="stat-label">今日费用</div>
            <div class="stat-value">$<span x-text="statsData?.limits.currentDailyCost.toFixed(4)"></span></div>
          </div>
        </div>
        <div class="stat-card p-6">
          <h3 class="text-base font-bold text-sand-12 mb-4">Token 使用详情</h3>
          <div class="stats-grid stats-grid-4">
            <div class="model-card text-center"><div class="text-xs text-sand-10 mb-1">输入 Token</div><div class="text-xl font-bold text-blue-600 dark:text-blue-400" x-text="statsData?.usage.total.inputTokens.toLocaleString()"></div></div>
            <div class="model-card text-center"><div class="text-xs text-sand-10 mb-1">输出 Token</div><div class="text-xl font-bold text-green-600 dark:text-green-400" x-text="statsData?.usage.total.outputTokens.toLocaleString()"></div></div>
            <div class="model-card text-center"><div class="text-xs text-sand-10 mb-1">缓存创建</div><div class="text-xl font-bold text-purple-600 dark:text-purple-400" x-text="statsData?.usage.total.cacheCreationTokens?.toLocaleString() || '0'"></div></div>
            <div class="model-card text-center"><div class="text-xs text-sand-10 mb-1">缓存读取</div><div class="text-xl font-bold text-amber-600 dark:text-amber-400" x-text="statsData?.usage.total.cacheReadTokens?.toLocaleString() || '0'"></div></div>
          </div>
        </div>
        <div class="stat-card p-6">
          <h3 class="text-base font-bold text-sand-12 mb-4">配额状态</h3>
          <div class="space-y-4">
            <div x-show="statsData?.limits.rateLimitRequests > 0">
              <div class="flex justify-between text-sm mb-2"><span class="text-sand-11">当前窗口请求</span><span class="font-semibold text-sand-12"><span x-text="statsData?.limits.currentWindowRequests"></span> / <span x-text="statsData?.limits.rateLimitRequests"></span></span></div>
              <div class="progress-container"><div class="progress-bar-fill" :class="(statsData?.limits.currentWindowRequests / statsData?.limits.rateLimitRequests * 100) > 80 ? 'progress-red' : 'progress-blue'" :style="'width: ' + Math.min(100, (statsData?.limits.currentWindowRequests / statsData?.limits.rateLimitRequests * 100)) + '%'"></div></div>
            </div>
            <div x-show="statsData?.limits.tokenLimit > 0">
              <div class="flex justify-between text-sm mb-2"><span class="text-sand-11">当前窗口 Token</span><span class="font-semibold text-sand-12"><span x-text="statsData?.limits.currentWindowTokens.toLocaleString()"></span> / <span x-text="statsData?.limits.tokenLimit.toLocaleString()"></span></span></div>
              <div class="progress-container"><div class="progress-bar-fill" :class="(statsData?.limits.currentWindowTokens / statsData?.limits.tokenLimit * 100) > 80 ? 'progress-red' : 'progress-green'" :style="'width: ' + Math.min(100, (statsData?.limits.currentWindowTokens / statsData?.limits.tokenLimit * 100)) + '%'"></div></div>
            </div>
            <div class="stats-grid stats-grid-2 mt-4" x-show="statsData?.limits.windowRemainingSeconds">
              <div class="model-card"><div class="text-xs text-sand-10 mb-1">窗口剩余时间</div><div class="text-lg font-bold text-sand-12"><span x-text="Math.floor(statsData?.limits.windowRemainingSeconds / 60)"></span> 分钟</div></div>
              <div class="model-card"><div class="text-xs text-sand-10 mb-1">窗口总时长</div><div class="text-lg font-bold text-sand-12"><span x-text="statsData?.limits.rateLimitWindowMinutes || '-'"></span> 分钟</div></div>
            </div>
          </div>
        </div>
        <div class="stat-card p-6" x-show="modelStats.length > 0">
          <h3 class="text-base font-bold text-sand-12 mb-4">模型使用统计</h3>
          <div class="space-y-3">
            <template x-for="model in modelStats" :key="model.model">
              <div class="model-card">
                <div class="flex justify-between items-center mb-3"><span class="font-semibold text-sm text-sand-12" x-text="model.model"></span><span class="badge badge-accent" x-text="model.formatted.total"></span></div>
                <div class="stats-grid stats-grid-4 text-xs">
                  <div><span class="text-sand-10">请求</span><div class="font-semibold text-sand-12" x-text="model.requests"></div></div>
                  <div><span class="text-sand-10">输入</span><div class="font-semibold text-sand-12" x-text="model.inputTokens.toLocaleString()"></div></div>
                  <div><span class="text-sand-10">输出</span><div class="font-semibold text-sand-12" x-text="model.outputTokens.toLocaleString()"></div></div>
                  <div><span class="text-sand-10">总计</span><div class="font-semibold text-sand-12" x-text="model.allTokens.toLocaleString()"></div></div>
                </div>
              </div>
            </template>
          </div>
        </div>
        <div class="stat-card p-6 text-center text-sand-11" x-show="modelStats.length === 0">暂无模型使用统计数据</div>
      </div>
    </div>
  </main>
  <script>
    function statsApp() {
      return {
        theme: localStorage.getItem('theme') || 'light',
        accent: localStorage.getItem('accent') || 'iris',
        apiKeyId: '',
        statsData: null,
        modelStats: [],
        loading: false,
        error: '',
        init() {
          this.$watch('theme', val => localStorage.setItem('theme', val));
          this.$watch('accent', val => localStorage.setItem('accent', val));
          const urlParams = new URLSearchParams(window.location.search);
          const keyId = urlParams.get('id');
          if (keyId) { this.apiKeyId = keyId; this.queryStats(); }
        },
        async queryStats() {
          const input = this.apiKeyId.trim();
          if (!input) { this.error = '请输入 API Key'; return; }
          this.loading = true; this.error = ''; this.statsData = null; this.modelStats = [];
          const uuidRegex = /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i;
          const isUUID = uuidRegex.test(input);
          let apiId = input;
          try {
            if (!isUUID) {
              const idResponse = await fetch('/apiStats/api/get-key-id', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ apiKey: input }) });
              if (!idResponse.ok) { const errorData = await idResponse.json(); throw new Error(errorData.message || '无效的 API Key'); }
              const idResult = await idResponse.json();
              apiId = idResult.data.id;
            }
            const response = await fetch('/apiStats/api/user-stats', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ apiId: apiId }) });
            if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.message || '查询失败'); }
            const result = await response.json();
            this.statsData = result.data;
            const modelResponse = await fetch('/apiStats/api/user-model-stats', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ apiId: apiId, period: 'monthly' }) });
            if (modelResponse.ok) { const modelResult = await modelResponse.json(); this.modelStats = modelResult.data || []; }
          } catch (err) { this.error = err.message || '查询失败，请检查网络连接'; console.error('Query error:', err); } finally { this.loading = false; }
        }
      }
    }
  </script>
</body>
</html>
